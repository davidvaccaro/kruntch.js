(function (e, t) { function n(e) { return !isNaN(parseFloat(e)) && isFinite(e) } function r(e, t) { var n = {}; for (m in e) n[m] = e[m]; for (m in t) n[m] = t[m]; return n } function i(e, t, n, r) { var i; var s = e + ""; var o = -1; if (typeof t === "string") { if (r) { i = t.toLowerCase(); while ((o = s.toLowerCase().indexOf(t, o >= 0 ? o + n.length : 0)) !== -1) { s = s.substring(0, o) + n + s.substring(o + t.length) } } else { return e.split(t).join(n) } } return s } function s(e) { if (e == " " || e == "\r" || e == "\n") return true; return false } function o(e) { try { return e instanceof HTMLElement } catch (t) { return typeof e === "object" && e.nodeType === 1 && typeof e.style === "object" && typeof e.ownerDocument === "object" } } function u(e) { var t = document.createElement("div"); t.appendChild(e.cloneNode(true)); return t.innerHTML } function a(e) { var t = e.cloneNode(true); for (var n = t.childNodes.length - 1; n >= 0; n--) { if (t.childNodes[n].tagName) t.removeChild(t.childNodes[n]) } return t["innerText" in t ? "innerText" : "textContent"] } function f(e, t, n) { var r = null; if (o(e) == true) { r = e; e = r.innerHTML } e = i(e, t, n, true); e = i(e, t + '=""', n, true); if (r != null) r.innerHTML = e; return e } function l(e, t, n) { if (o(n) == true) e.replaceChild(n, t); else { var r = document.createElement("div"); r.innerHTML = n; var i = []; for (var s = 0; s < r.childNodes.length; s++) i.push(r.childNodes[s]); for (s = 0; s < i.length; s++) e.insertBefore(i[s], t); e.removeChild(t) } return } function c(e, t) { if (o(t) == true) e.appendChild(t); else { var n = document.createElement("div"); n.innerHTML = t; var r = []; for (var i = 0; i < n.childNodes.length; i++) r.push(n.childNodes[i]); for (i = 0; i < r.length; i++) e.appendChild(r[i]) } return } function h(e) { var n = document.getElementsByTagName("*"); for (var r = 0; r < n.length; r++) { var i = n[r].getAttribute("data-templateid"); if (i != t && i != null && i == e) { if (n[r].nodeName.toUpperCase() == "TEXTAREA") return n[r].value; else return n[r].innerHTML } } return "" } function p(e) { var t = document.createElement("div"); t.innerHTML = e; return t.children[0] } function d(e) { var n = e.attributes["_ktype"]; if (n != t) return n.nodeValue; return "" } function v(e) { if (e == t || e == null || e == "" || e.children == t || e.children.length == 0) return false; for (var n = 0; n < e.children.length; n++) { var r = d(e.children[n]); if (r == "IF" || r == "ELSEIF" || r == "ELSE" || r == "FOR" || r == "WITH") return true; if (v(e.children[n]) == true) return true } return false } function g(e, n) { var r = e; var i = n.split("."); for (var s = 0; s < i.length; s++) { r = e; e = e[i[s]]; if (typeof e == "function") e = e.call(r) } if (e == t || e == null) e = ""; return e } function y(e, t, n) { return (new Function("return (" + e.root.conditions[n] + ")")).call(t) } function b(e, t, n) { return (new Function("return (" + e.root.wheres[n] + ")")).call(t) } function w(e, r, i, s) { var o = { items: [], names: [], lookup: {}, at: function (e) { if (n(e) == true) return this.items[e]; return this.lookup[e] } }; var u = g(r, i); if (u == t) return o; var a = []; if (!(u instanceof Array)) { var f = []; a = []; for (var l in u) { a.push(l); f.push(u[l]) } u = f } if (s != t) { var c = new Function("return (" + e.root.wheres[s] + ")"); var h = []; var p = []; for (var d = 0; d < u.length; d++) { var v = u[d]; var m = a[d]; v.Parent = r; if (c.call(v) == true) { h.push(v); p.push(m) } } u = h; a = p } o.items = u; o.names = a; for (var y = 0; y < o.names.length; y++) o.lookup[o.names[y]] = o.items[y]; return o } function E(e) { var n = []; var r = { any: t, first: t, last: t, nth: [] }; for (var i = 0; i < e.dom.children.length; i++) { var s = e.dom.children[i]; var o = d(s); if (o == "FIRST") { r.first = s; n.push(s) } else if (o == "LAST") { r.last = s; n.push(s) } else if (o == "NTH") { r.nth.push({ template: s, every: t, at: t, where: t }); var u = r.nth[r.nth.length - 1]; u.every = s.getAttribute("every"); u.at = s.getAttribute("at"); u.where = s.getAttribute("where"); if (u.at != t && u.at.indexOf(",") > -1) { var a = u.at.split(","); u.at = a[0]; for (var f = 1; f < a.length; f++) r.nth.push({ template: s, every: u.every, at: a[f], where: u.where }) } n.push(s) } } for (i = 0; i < n.length; i++) e.dom.removeChild(n[i]); r.any = e.dom; if (r.first != t || r.last != t || r.nth.length > 0) r.hasTargets = true; else r.hasTargets = false; return r } function S(e, n, r, i, s) { if (n.details == t) n.details = E(n); var o = t; if (n.details.hasTargets == true) { if (n.details.first != t && r == 0) o = n.details.first; else if (n.details.last != t && r == i - 1) o = n.details.last; else { for (var u = 0; u < n.details.nth.length; u++) { if (n.details.nth[u].every != t && r % n.details.nth[u].every == 0) { if (n.details.nth[u].where != t && b(n, s, n.details.nth[u].where) == false) continue; o = n.details.nth[u].template; break } if (n.details.nth[u].at != t && r == n.details.nth[u].at) { if (n.details.nth[u].where != t && b(n, s, n.details.nth[u].where) == false) continue; o = n.details.nth[u].template; break } if (n.details.nth[u].where != t && b(n, s, n.details.nth[u].where) == true) { o = n.details.nth[u].template; break } } if (o == t) o = n.details.any } } else o = n.dom; return o } function x(e) { var n = { first: t, last: t, nth: [] }; for (var r = 0; r < e.dom.children.length; r++) { var i = e.dom.children[r]; var s = d(i); if (s == "FIRST") { n.first = i } else if (s == "LAST") { n.last = i } else if (s == "NTH") { n.nth.push({ template: i, at: t }); var o = n.nth[n.nth.length - 1]; o.at = i.getAttribute("at"); if (o.at != t && o.at.indexOf(",") > -1) { var u = o.at.split(","); o.at = u[0]; for (var a = 1; a < u.length; a++) n.nth.push({ template: i, at: u[a] }) } } } return n } function T(e, t) { var n = []; for (var r = 0; r < t.children.length; r++) { if (d(t.children[r]) == "ELSEIF") n.push(t.children[r]) } for (r = 0; r < t.children.length; r++) { if (d(t.children[r]) == "ELSE") n.push(t.children[r]) } for (r = 0; r < n.length; r++) t.removeChild(n[r]); var i = null; if (y(e, e.view, t.getAttribute("condition")) == true) i = t; else { for (r = 0; r < n.length; r++) { if (d(n[r]) == "ELSE") { i = n[r]; break } if (y(e, e.view, n[r].attr("condition")) == true) { i = n[r]; break } } } return i != null ? _(A(i, e), e.view) : "" } function N(e, n) { var r = ""; var i = w(e, e.view, n.getAttribute("each"), n.getAttribute("where")); var s = { dom: n }; for (var o = 0; o < i.items.length; o++) { var u = i.items[o]; var a = u.toString(); var f = i.names != t && i.names.length > 0 ? i.names[o] : (o + 1).toString(); var l = a != t && a != {}.toString() ? a : ""; var c = S(e, s, o, i.items.length, u); u.Parent = e.view; r += _(O(c, e, f, i.items.length, l), u) } return r } function C(e, n) { var r = ""; var i = w(e, e.view, n.getAttribute("in"), n.getAttribute("where")); var s = { dom: n, details: t }; s.details = x(s); for (var o = 0; o < s.details.nth.length; o++) { var u = i.at(s.details.nth[o].at); if (u == t) continue; var a = u.toString(); var f = s.details.nth[o].at; var l = a != t && a != {}.toString() ? a : ""; var c = s.details.nth[o].template; u.Parent = e.view; r += _(O(c, e, f, i.items.length, l), u) } return r } function k(e) { var t = (new Date).getTime(); e.properties = new Object; e.scripts = new Object; e.code = new Object; e.conditions = new Object; e.wheres = new Object; e.pre = e.raw; var n, r; while ((n = e.pre.indexOf("{{")) >= 0) { var o = "_k1_" + (t++).toString(); r = e.pre.indexOf("}}", n); var u = e.pre.slice(n, r + 1); e.pre = [e.pre.slice(0, n), o, e.pre.slice(r + 2)].join(""); e.scripts[o] = u.trim() } while ((n = e.pre.indexOf("[")) >= 0) { var o = "_k1_" + (t++).toString(); r = e.pre.indexOf("]", n); var a = e.pre.slice(n, r + 1); e.pre = [e.pre.slice(0, n), o, e.pre.slice(r + 1)].join(""); e.properties[o] = a.trim() } while ((n = e.pre.indexOf("{")) >= 0) { var o = "_k1_" + (t++).toString(); r = e.pre.indexOf("}", n); var f = e.pre.slice(n, r + 1); e.pre = [e.pre.slice(0, n), o, e.pre.slice(r + 1)].join(""); e.code[o] = f.trim() } this.parsePropCodes = function (i) { var o = new Object; n = 0; while ((n = e.pre.indexOf(i, n)) >= 0) { while (s(e.pre.charAt(n)) == false && e.pre.charAt(n) != "=") n++; while (s(e.pre.charAt(n)) == true) n++; if (e.pre.charAt(n) == "=") { n++; while (s(e.pre.charAt(n)) == true) n++; if (e.pre.charAt(n) == '"' || e.pre.charAt(n) == "'") { var u = e.pre.charAt(n); n++; r = e.pre.indexOf(u, n); var a = "_k1_" + (t++).toString(); var f = e.pre.slice(n, r); e.pre = [e.pre.slice(0, n), a, e.pre.slice(r)].join(""); o[a] = f.trim() } } } return o }; this.parseSpecialElements = function (t) { n = 0; while ((n = e.pre.indexOf("<", n)) >= 0) { var r = n; var i = ""; var o = false; n++; while (s(e.pre.charAt(n)) == true) n++; if (e.pre.charAt(n) == "/") { n++; o = true } while (s(e.pre.charAt(n)) == true) n++; while (s(e.pre.charAt(n)) == false && e.pre.charAt(n) != ">") { i += e.pre.charAt(n); n++ } if (i.toLowerCase() == t.toLowerCase()) { e.pre = [e.pre.slice(0, r), "<" + (o == true ? "/" : "") + 'div _ktype="' + t.toUpperCase() + '"', e.pre.slice(n)].join("") } } return }; e.conditions = this.parsePropCodes("condition"); e.wheres = this.parsePropCodes("where"); this.parseSpecialElements("if"); this.parseSpecialElements("elseif"); this.parseSpecialElements("else"); this.parseSpecialElements("for"); this.parseSpecialElements("with"); this.parseSpecialElements("nth"); this.parseSpecialElements("first"); this.parseSpecialElements("last"); e.pre = i(e.pre, "src", "_src", true); e.pre = i(e.pre, "href", "_href", true); e.pre = "<div>" + e.pre + "</div>"; return e } function L(e) { var n = { raw: t, pre: t, dom: t, root: t, parent: t, view: t }; n.root = n; var r = /^[a-z0-9]+$/i; if (r.test(e) == true) n.raw = h(e); else n.raw = e; n = k(n); n.dom = p(n.pre); return n } function A(e, n) { var r = { raw: t, pre: t, dom: t, root: n.root, parent: n, view: t }; var i = /^[a-z0-9]+$/i; if (i.test(e) == true) r.dom = p(r.pre); else if (e == "string") r.dom = p(e); else r.dom = e.cloneNode(true); r.pre = r.raw; return r } function O(e, t, n, r, i) { var s = A(e, t); s.index = n; s.count = r; s.str = i; return s } function M(e, n, i) { var s = {}; var o = a(i); s = r(s, n); s.Ready = t; for (var u in e) { if (o.indexOf(u) >= 0) { f(i, u, ""); var l = e[u]; l = l.substring(2, l.length - 2).trim(); l = "return {" + l + "}"; s = r(s, (new Function(l)).call(s)) } } return s } function _(e, t) { e.view = M(e.root.scripts, t, e.dom); var n = []; for (var r = 0; r < e.dom.children.length; r++) { var s = e.dom.children[r]; var o = d(s); if (o == "IF") n.push({ p: s.parentNode, r: s, w: T(e, s) }); else if (o == "FOR") n.push({ p: s.parentNode, r: s, w: N(e, s) }); else if (o == "WITH") n.push({ p: s.parentNode, r: s, w: C(e, s) }); else if (v(s) == true) { s.innerHTML = _(A(s, e), e.view) } } for (var u = 0; u < n.length; u++) l(n[u].p, n[u].r, n[u].w); var a = e.dom.innerHTML; for (var c in e.root.code) { if (a.indexOf(c) >= 0) { var h = e.root.code[c]; h = h.substring(1, h.length - 1); a = f(a, c, (new Function(h)).call(e.view)) } } for (var p in e.root.properties) { if (a.indexOf(p) >= 0) { var m = e.root.properties[p]; m = m.substring(1, m.length - 1).trim(); if (m == "#") a = f(a, p, e.index); else if (m == "##") a = f(a, p, e.count); else if (m == "$") a = f(a, p, e.str); else a = f(a, p, g(e.view, m)) } } a = i(a, "_src", "src", true); a = i(a, "_href", "href", true); return a } function D(e, n, r) { var i = L(e); var s = _(i, n); if (r != t && r != null) c(r, s); if (i.view.Ready != t) i.view.Ready.call(i.view); return s } e.Apply = function (n, r, i, s, o) { if (s == t) s = false; if (s == true) { window.setTimeout(function () { e.Apply(n, r, i, false, o) }, 1); return "" } var u = D(n, r, i); if (o != t) o(u); return u }; e.Bind = function (e, t) { var n = L(e); return M(n.root.scripts, t, n.dom) } })(window.Kruntch = window.Kruntch || {})